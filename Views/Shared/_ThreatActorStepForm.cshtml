@model CyberRiskApp.ViewModels.ThreatActorStepViewModel
@{
    var scenarioIndex = ViewData["ScenarioIndex"]?.ToString() ?? "0";
    var stepIndex = ViewData["StepIndex"]?.ToString() ?? "0";
}

<div class="card mb-3 threat-actor-step" data-step-index="@stepIndex">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Step @(int.Parse(stepIndex) + 1)</h6>
            <button type="button" class="btn btn-sm btn-outline-danger" 
                    onclick="removeThreatActorStep(@scenarioIndex, @stepIndex)">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <label class="form-label fw-bold">Step Name</label>
                <input name="ThreatScenarios[@scenarioIndex].ThreatActorSteps[@stepIndex].Name" 
                       value="@Model.Name" 
                       class="form-control" 
                       placeholder="e.g., Credential Harvesting" />
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold">MITRE ATT&CK Technique</label>
                <input name="ThreatScenarios[@scenarioIndex].ThreatActorSteps[@stepIndex].MitreTechnique" 
                       value="@Model.MitreTechnique" 
                       class="form-control mitre-technique-input" 
                       placeholder="e.g., T1555 - Credentials from Password Stores" />
            </div>
        </div>
        <div class="mt-3">
            <label class="form-label fw-bold">Description</label>
            <textarea name="ThreatScenarios[@scenarioIndex].ThreatActorSteps[@stepIndex].Description" 
                      class="form-control" 
                      rows="2" 
                      placeholder="Describe what the threat actor does in this step...">@Model.Description</textarea>
        </div>
        
        <!-- Simplified Controls Section -->
        <div class="row mt-3">
            <div class="col-md-3">
                <label class="form-label fw-bold text-success">Current Protective</label>
                <div id="step-current-protective-@scenarioIndex-@stepIndex" class="controls-container">
                    <!-- Controls will be added dynamically -->
                </div>
                <button type="button" class="btn btn-sm btn-outline-success" 
                        onclick="addControl('step-current-protective-@scenarioIndex-@stepIndex', '@scenarioIndex', 'ThreatActorSteps[@stepIndex].CurrentProtectiveControls')">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold text-info">Current Detective</label>
                <div id="step-current-detective-@scenarioIndex-@stepIndex" class="controls-container">
                    <!-- Controls will be added dynamically -->
                </div>
                <button type="button" class="btn btn-sm btn-outline-info" 
                        onclick="addControl('step-current-detective-@scenarioIndex-@stepIndex', '@scenarioIndex', 'ThreatActorSteps[@stepIndex].CurrentDetectiveControls')">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold text-warning">Needed Protective</label>
                <div id="step-needed-protective-@scenarioIndex-@stepIndex" class="controls-container">
                    <!-- Controls will be added dynamically -->
                </div>
                <button type="button" class="btn btn-sm btn-outline-warning" 
                        onclick="addControl('step-needed-protective-@scenarioIndex-@stepIndex', '@scenarioIndex', 'ThreatActorSteps[@stepIndex].NeededProtectiveControls')">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold text-secondary">Needed Detective</label>
                <div id="step-needed-detective-@scenarioIndex-@stepIndex" class="controls-container">
                    <!-- Controls will be added dynamically -->
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary" 
                        onclick="addControl('step-needed-detective-@scenarioIndex-@stepIndex', '@scenarioIndex', 'ThreatActorSteps[@stepIndex].NeededDetectiveControls')">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    </div>
</div>