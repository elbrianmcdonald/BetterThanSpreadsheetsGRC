@model CyberRiskApp.ViewModels.FAIRAssessmentViewModel
@{
    ViewData["Title"] = "Create Risk Assessment";
}

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-11">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-shield-alt text-primary me-2"></i>
                    Create Risk Assessment
                </h2>
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to List
                </a>
            </div>

            <form asp-action="Create" method="post" id="riskAssessmentForm" novalidate>
                <div asp-validation-summary="All" class="alert alert-danger"></div>
                
                <!-- Basic Information -->
                <div class="card mb-4">
                    <div class="card-header bg-primary bg-opacity-10">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Basic Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Assessment.Title" class="form-label fw-bold">Assessment Title <span class="text-danger">*</span></label>
                                    <input asp-for="Assessment.Title" class="form-control" placeholder="Enter assessment title" required />
                                    <span asp-validation-for="Assessment.Title" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Assessment.Asset" class="form-label fw-bold">Primary Asset <span class="text-danger">*</span></label>
                                    @Html.AssetComboboxFor(m => m.Assessment.Asset, canAddNew: User.IsInRole("Admin") || User.IsInRole("GRCAnalyst") || User.IsInRole("GRCManager"), required: true)
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Assessment.BusinessUnit" class="form-label fw-bold">Business Unit</label>
                                    @Html.BusinessUnitComboboxFor(m => m.Assessment.BusinessUnit, canAddNew: User.IsInRole("Admin") || User.IsInRole("GRCAnalyst") || User.IsInRole("GRCManager"))
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Assessment.BusinessOwner" class="form-label fw-bold">Business Owner</label>
                                    @Html.BusinessOwnerComboboxFor(m => m.Assessment.BusinessOwner, canAddNew: User.IsInRole("Admin") || User.IsInRole("GRCAnalyst") || User.IsInRole("GRCManager"))
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Assessment.AssessmentType" class="form-label fw-bold">Assessment Type</label>
                                    <select asp-for="Assessment.AssessmentType" class="form-control" id="assessmentType">
                                        <option value="1">FAIR (Quantitative)</option>
                                        <option value="0">Qualitative</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Assessment.CIATriad" class="form-label fw-bold">CIA Triad Impact</label>
                                    <select asp-for="Assessment.CIATriad" class="form-control">
                                        <option value="">Select CIA Impact</option>
                                        <option value="1">Confidentiality</option>
                                        <option value="2">Integrity</option>
                                        <option value="3">Availability</option>
                                        <option value="4">Confidentiality & Integrity</option>
                                        <option value="5">Confidentiality & Availability</option>
                                        <option value="6">Integrity & Availability</option>
                                        <option value="7">All Three (CIA)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="Assessment.ThreatScenario" class="form-label fw-bold">Threat Scenario <span class="text-danger">*</span></label>
                            <textarea asp-for="Assessment.ThreatScenario" class="form-control" rows="3" placeholder="Describe the threat scenario in detail" required></textarea>
                            <span asp-validation-for="Assessment.ThreatScenario" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="Assessment.Description" class="form-label fw-bold">Additional Description</label>
                            <textarea asp-for="Assessment.Description" class="form-control" rows="2" placeholder="Optional additional details"></textarea>
                        </div>

                    </div>
                </div>

                <!-- Qualitative Analysis Section -->
                <div id="qualitativeSection" class="card mb-4">
                    <div class="card-header bg-warning bg-opacity-10">
                        <h5 class="mb-0">
                            <i class="fas fa-balance-scale me-2"></i>Qualitative Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="Assessment.QualitativeLikelihood" class="form-label fw-bold">Likelihood Level</label>
                                    <select asp-for="Assessment.QualitativeLikelihood" asp-items="Html.GetEnumSelectList<CyberRiskApp.Models.LikelihoodLevel>()" class="form-control">
                                        <option value="">Select Likelihood</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="Assessment.QualitativeImpact" class="form-label fw-bold">Impact Level</label>
                                    <select asp-for="Assessment.QualitativeImpact" asp-items="Html.GetEnumSelectList<CyberRiskApp.Models.ImpactLevel>()" class="form-control">
                                        <option value="">Select Impact</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="Assessment.QualitativeExposure" class="form-label fw-bold">Exposure Level</label>
                                    <select asp-for="Assessment.QualitativeExposure" asp-items="Html.GetEnumSelectList<CyberRiskApp.Models.ExposureLevel>()" class="form-control">
                                        <option value="">Select Exposure</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        
                        <!-- Defense in Depth Controls for Qualitative Assessments -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-shield-alt me-2"></i>Defense in Depth - Security Controls in Place
                                </h6>
                                <div class="alert alert-info mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Document security controls that are in place to mitigate this risk. These controls help inform the overall risk assessment but do not automatically calculate vulnerability reduction in qualitative assessments.
                                </div>
                                
                                <div id="qualitativeControlsContainer" class="mb-3">
                                    <!-- Controls will be dynamically added here -->
                                </div>
                                
                                <button type="button" class="btn btn-sm btn-primary mb-4" onclick="addQualitativeControl()">
                                    <i class="fas fa-plus me-1"></i>Add Control
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Identified Risks Section -->
                <div class="card mb-4">
                    <div class="card-header bg-danger bg-opacity-10">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>Identified Risks
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Add specific risks identified during this assessment that need to be tracked and managed.
                        </div>
                        
                        <!-- Column Headers -->
                        <div class="row mb-2 d-none" id="riskHeaders">
                            <div class="col-md-2">
                                <small class="text-muted fw-bold">Risk Title</small>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted fw-bold">Risk Description</small>
                            </div>
                            <div class="col-md-1">
                                <small class="text-muted fw-bold">Owner</small>
                            </div>
                            <div class="col-md-1">
                                <small class="text-muted fw-bold">Inherent Risk</small>
                            </div>
                            <div class="col-md-1">
                                <small class="text-muted fw-bold">Treatment</small>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted fw-bold">Additional Controls</small>
                            </div>
                            <div class="col-md-1">
                                <small class="text-muted fw-bold">Residual Risk</small>
                            </div>
                            <div class="col-md-1">
                                <small class="text-muted fw-bold">Actions</small>
                            </div>
                        </div>
                        
                        <div id="risksContainer">
                            <!-- Risks will be added here dynamically -->
                        </div>
                        
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="addRisk()">
                            <i class="fas fa-plus me-2"></i>Add Risk
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm ms-2" onclick="updateAllRiskLevels()">
                            <i class="fas fa-sync me-2"></i>Update Risk Levels
                        </button>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save me-2"></i>Create Assessment
                            </button>
                            <a asp-action="Index" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let controlIndex = 0;
        let qualitativeControlIndex = 0;
        let riskIndex = 0;
        let insuranceAmount = 0; // Store insurance amount for calculations
        
        // FAIR control management functions removed
        
        // Qualitative control management functions
        function addQualitativeControl() {
            const container = document.getElementById('qualitativeControlsContainer');
            const canAddNew = '@(User.IsInRole("Admin") || User.IsInRole("GRCAnalyst") || User.IsInRole("GRCManager"))' === 'True';
            const controlHtml = `
                <div class="control-item card mb-2 border-primary" id="qualitative_control_${qualitativeControlIndex}">
                    <div class="card-body p-3">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <select name="QualitativeControls[${qualitativeControlIndex}].ControlName" 
                                        class="form-select control-name-select" 
                                        data-category="5" 
                                        data-can-add-new="${canAddNew ? 'true' : 'false'}"
                                        data-placeholder="Type to search controls..."
                                        required 
                                        style="width: 100%;">
                                    <option value="">Type to search controls...</option>
                                </select>
                                <input type="hidden" name="QualitativeControls[${qualitativeControlIndex}].Id" value="0" />
                            </div>
                            <div class="col-md-2">
                                <select name="QualitativeControls[${qualitativeControlIndex}].ControlType" class="form-control form-control-sm" required>
                                    <option value="Preventive">Preventive</option>
                                    <option value="Detective">Detective</option>
                                    <option value="Responsive">Responsive</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select name="QualitativeControls[${qualitativeControlIndex}].ImplementationStatus" 
                                        class="form-control form-control-sm control-status" required>
                                    <option value="Implemented">Implemented</option>
                                    <option value="Planned">Planned</option>
                                    <option value="NotImplemented">Not Implemented</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="text" name="QualitativeControls[${qualitativeControlIndex}].ControlDescription" 
                                       class="form-control form-control-sm" placeholder="Description" />
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQualitativeControl(${qualitativeControlIndex})" title="Remove Control">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', controlHtml);
            
            // Smart combobox will be initialized by global smart-combobox.js
            // No need to manually initialize here
            
            qualitativeControlIndex++;
            
            // Trigger global initialization for newly added elements
            if (window.initializeSmartComboboxes) {
                window.initializeSmartComboboxes();
            }
        }
        
        function removeQualitativeControl(index) {
            document.getElementById(`qualitative_control_${index}`).remove();
        }
        
        // Setup smart combobox for newly added qualitative control
        function setupNewQualitativeControlCombobox(index) {
            const select = document.querySelector(`select[name="Controls[${index}].ControlName"]`);
            if (!select) return;
            
            const $select = $(select);
            
            // Skip if already initialized
            if ($select.hasClass('select2-hidden-accessible')) {
                return;
            }
            
            const canAddNew = select.dataset.canAddNew === 'true';
            const category = select.dataset.category;
            
            $select.select2({
                placeholder: 'Type to search controls...',
                allowClear: true,
                ajax: {
                    url: '/ReferenceData/Search',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            term: params.term,
                            category: category
                        };
                    },
                    processResults: function (data) {
                        let results = data.map(item => ({
                            id: item.value,
                            text: item.text
                        }));
                        
                        // Add "Add new" option if user can create and there's a search term
                        if (canAddNew && params.term && params.term.length > 0) {
                            results.unshift({
                                id: 'ADD_NEW:' + params.term,
                                text: '+ Add new: "' + params.term + '"',
                                newItem: true
                            });
                        }
                        
                        return { results: results };
                    },
                    cache: true
                },
                templateResult: function(data) {
                    if (data.loading) return data.text;
                    if (data.newItem) {
                        return $('<span style="font-style: italic; color: #007bff;"><i class="fas fa-plus me-1"></i>' + data.text + '</span>');
                    }
                    return data.text;
                }
            });
            
            // Handle selection
            $select.on('select2:select', function (e) {
                const selectedValue = e.params.data.id;
                if (selectedValue.startsWith('ADD_NEW:')) {
                    const newValue = selectedValue.replace('ADD_NEW:', '');
                    
                    // Create new reference data item
                    $.ajax({
                        url: '/ReferenceData/Create',
                        method: 'POST',
                        data: {
                            value: newValue,
                            category: category
                        },
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function(response) {
                            if (response.success) {
                                $select.empty().append(new Option(newValue, newValue, true, true));
                                showAlert('success', 'Control "' + newValue + '" has been added successfully!');
                            } else {
                                showAlert('error', 'Failed to add new control: ' + (response.message || 'Unknown error'));
                                $select.val(null).trigger('change');
                            }
                        },
                        error: function() {
                            showAlert('error', 'Error adding new control. Please try again.');
                            $select.val(null).trigger('change');
                        }
                    });
                }
            });
        }
        
        // Risk management functions
        function addRisk() {
            const container = document.getElementById('risksContainer');
            const canAddNew = '@(User.IsInRole("Admin") || User.IsInRole("GRCAnalyst") || User.IsInRole("GRCManager"))' === 'True';
            const riskHtml = `
                <div class="risk-item card mb-2 border-danger" id="risk_${riskIndex}">
                    <div class="card-body p-2">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <input type="text" name="IdentifiedRisks[${riskIndex}].Title" 
                                       class="form-control form-control-sm" 
                                       placeholder="Risk Title" required />
                            </div>
                            <div class="col-md-3">
                                <textarea name="IdentifiedRisks[${riskIndex}].Description" 
                                          class="form-control form-control-sm" 
                                          rows="2" placeholder="Risk Description"></textarea>
                            </div>
                            <div class="col-md-1">
                                <select name="IdentifiedRisks[${riskIndex}].Owner" 
                                        class="form-select form-select-sm risk-owner-select" 
                                        data-category="2" 
                                        data-can-add-new="${canAddNew}" 
                                        data-placeholder="Select owner..." 
                                        style="width: 100%;">
                                    <option value="">Select...</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                                <div class="d-flex flex-column align-items-center">
                                    <span id="inherentRiskLevel_${riskIndex}" class="badge bg-secondary mb-1">TBD</span>
                                    <input type="hidden" name="IdentifiedRisks[${riskIndex}].InherentRiskLevel" id="inherentRiskLevelValue_${riskIndex}" value="1" />
                                    <small class="text-muted">Auto-calc</small>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <select name="IdentifiedRisks[${riskIndex}].Treatment" 
                                        class="form-select form-select-sm" 
                                        onchange="updateResidualRisk(${riskIndex})">
                                    <option value="1">Mitigate</option>
                                    <option value="2">Transfer</option>
                                    <option value="3">Accept</option>
                                    <option value="4">Avoid</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <textarea name="IdentifiedRisks[${riskIndex}].TreatmentPlan" 
                                          class="form-control form-control-sm" 
                                          rows="2" 
                                          placeholder="Additional controls needed..."
                                          onchange="updateResidualRisk(${riskIndex})"></textarea>
                            </div>
                            <div class="col-md-1">
                                <select name="IdentifiedRisks[${riskIndex}].ResidualRiskLevel" 
                                        class="form-select form-select-sm" 
                                        id="residualRiskLevel_${riskIndex}">
                                    <option value="1">Low</option>
                                    <option value="2">Medium</option>
                                    <option value="3">High</option>
                                    <option value="4">Critical</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRisk(${riskIndex})" title="Remove Risk">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', riskHtml);
            
            // Show headers when first risk is added
            if (riskIndex === 0) {
                document.getElementById('riskHeaders').classList.remove('d-none');
            }
            
            // Initialize smart combobox for the newly added risk owner select
            if (window.initializeSmartComboboxes) {
                window.initializeSmartComboboxes();
            }
            
            riskIndex++;
            
            // Update risk levels immediately after adding
            setTimeout(() => {
                updateAllRiskLevels();
            }, 100);
        }
        
        function removeRisk(index) {
            document.getElementById(`risk_${index}`).remove();
            
            // Hide headers if no risks remain
            const remainingRisks = document.querySelectorAll('.risk-item');
            if (remainingRisks.length === 0) {
                document.getElementById('riskHeaders').classList.add('d-none');
            }
        }
        
        // Risk level calculation functions
        function calculateRiskLevel() {
            const assessmentType = document.getElementById('assessmentType').value;
            console.log('Assessment type:', assessmentType);
            
            if (assessmentType === '1') { // FAIR Assessment
                const result = calculateFairRiskLevel();
                console.log('FAIR result:', result);
                return result;
            } else { // Qualitative Assessment
                const result = calculateQualitativeRiskLevel();
                console.log('Qualitative result:', result);
                return result;
            }
        }
        
        function calculateFairRiskLevel() {
            // Get ALE from preview (remove commas and dollar signs)
            const aleText = document.getElementById('alePreview')?.textContent || '0';
            const ale = parseFloat(aleText.replace(/[$,]/g, '')) || 0;
            
            console.log('FAIR ALE calculation:', aleText, 'parsed to:', ale);
            
            // These thresholds should match RiskLevelSettings
            // TODO: Fetch these from the API for accuracy
            if (ale >= 1000000) return { level: 4, text: 'Critical', class: 'bg-danger' };
            if (ale >= 100000) return { level: 3, text: 'High', class: 'bg-warning' };
            if (ale >= 10000) return { level: 2, text: 'Medium', class: 'bg-info' };
            return { level: 1, text: 'Low', class: 'bg-success' };
        }
        
        function calculateQualitativeRiskLevel() {
            // Get qualitative risk score from calculation
            const likelihoodElement = document.querySelector('[name="Assessment.QualitativeLikelihood"]');
            const impactElement = document.querySelector('[name="Assessment.QualitativeImpact"]');
            const exposureElement = document.querySelector('[name="Assessment.QualitativeExposure"]');
            
            console.log('Qualitative elements:', likelihoodElement?.value, impactElement?.value, exposureElement?.value);
            
            if (!likelihoodElement?.value || !impactElement?.value || !exposureElement?.value) {
                console.log('Missing qualitative values, returning TBD');
                return { level: 1, text: 'TBD', class: 'bg-secondary' };
            }
            
            const likelihood = parseInt(likelihoodElement.value);
            const impact = parseInt(impactElement.value);
            const exposure = getExposureRating(parseInt(exposureElement.value));
            
            const riskScore = (likelihood * impact) * exposure;
            console.log('Calculated risk score:', riskScore, 'from', likelihood, '*', impact, '*', exposure);
            
            // These thresholds should match RiskLevelSettings
            if (riskScore >= 16) return { level: 4, text: 'Critical', class: 'bg-danger' };
            if (riskScore >= 10) return { level: 3, text: 'High', class: 'bg-warning' };
            if (riskScore >= 4) return { level: 2, text: 'Medium', class: 'bg-info' };
            return { level: 1, text: 'Low', class: 'bg-success' };
        }
        
        function getExposureRating(exposureLevel) {
            // Match the enum values to exposure ratings
            switch(exposureLevel) {
                case 1: return 0.2; // SlightlyExposed
                case 2: return 0.4; // Exposed
                case 3: return 0.8; // ModeratelyExposed
                case 4: return 1.0; // HighlyExposed
                default: return 0.2;
            }
        }
        
        function updateAllRiskLevels() {
            console.log('updateAllRiskLevels called');
            const riskLevel = calculateRiskLevel();
            console.log('Calculated risk level:', riskLevel);
            
            // Update all inherent risk level displays
            const riskItems = document.querySelectorAll('.risk-item');
            console.log('Found risk items:', riskItems.length);
            
            riskItems.forEach((item, index) => {
                const badge = item.querySelector(`[id^="inherentRiskLevel_"]`);
                const hiddenInput = item.querySelector(`[id^="inherentRiskLevelValue_"]`);
                
                console.log(`Risk item ${index}:`, badge, hiddenInput);
                
                if (badge && hiddenInput) {
                    badge.textContent = riskLevel.text;
                    badge.className = `badge ${riskLevel.class} mb-1`;
                    hiddenInput.value = riskLevel.level;
                    console.log(`Updated inherent risk ${index} to:`, riskLevel.text);
                    
                    // Also update residual risk default to same level initially
                    const residualSelect = item.querySelector(`[id^="residualRiskLevel_"]`);
                    if (residualSelect && !residualSelect.hasAttribute('data-user-modified')) {
                        residualSelect.value = riskLevel.level;
                    }
                }
            });
        }
        
        function updateResidualRisk(riskIndex) {
            const treatmentSelect = document.querySelector(`select[name="IdentifiedRisks[${riskIndex}].Treatment"]`);
            const treatmentPlan = document.querySelector(`textarea[name="IdentifiedRisks[${riskIndex}].TreatmentPlan"]`);
            const residualSelect = document.querySelector(`select[name="IdentifiedRisks[${riskIndex}].ResidualRiskLevel"]`);
            const inherentInput = document.querySelector(`input[name="IdentifiedRisks[${riskIndex}].InherentRiskLevel"]`);
            
            if (!treatmentSelect || !residualSelect || !inherentInput) return;
            
            // Mark residual risk as user-modified
            residualSelect.setAttribute('data-user-modified', 'true');
            
            const treatment = parseInt(treatmentSelect.value);
            const inherentLevel = parseInt(inherentInput.value);
            const hasTreatmentPlan = treatmentPlan && treatmentPlan.value.trim().length > 0;
            
            let suggestedResidual = inherentLevel;
            
            // Suggest residual risk reduction based on treatment strategy
            if (treatment === 1 && hasTreatmentPlan) { // Mitigate with controls
                suggestedResidual = Math.max(1, inherentLevel - 1); // Reduce by 1 level
            } else if (treatment === 2) { // Transfer
                suggestedResidual = Math.max(1, inherentLevel - 1); // Reduce by 1 level
            } else if (treatment === 4) { // Avoid
                suggestedResidual = 1; // Low risk if avoided
            }
            // Accept (3) keeps the same level
            
            // Only auto-update if user hasn't manually changed it recently
            const lastChanged = residualSelect.getAttribute('data-last-changed');
            const now = Date.now();
            if (!lastChanged || (now - parseInt(lastChanged)) > 5000) { // 5 second grace period
                residualSelect.value = suggestedResidual;
            }
        }
        
        // FAIR-specific calculation functions removed
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Update risk levels when qualitative fields change
            document.querySelectorAll('[name="Assessment.QualitativeLikelihood"], [name="Assessment.QualitativeImpact"], [name="Assessment.QualitativeExposure"]').forEach(input => {
                input.addEventListener('change', updateAllRiskLevels);
            });
            
            // Handle form submission
            document.getElementById('riskAssessmentForm').addEventListener('submit', function(e) {
                // Remove any empty identified risks to prevent validation errors
                const emptyRisks = document.querySelectorAll('.risk-item');
                emptyRisks.forEach(riskItem => {
                    const titleInput = riskItem.querySelector('input[name*="IdentifiedRisks"][name*="Title"]');
                    if (!titleInput || !titleInput.value.trim()) {
                        riskItem.remove();
                    }
                });
                
                // Check basic validation
                const requiredFields = ['Assessment.Title', 'Assessment.Asset', 'Assessment.ThreatScenario'];
                let isValid = true;
                
                requiredFields.forEach(fieldName => {
                    const field = document.querySelector(`[name="${fieldName}"]`);
                    if (!field || !field.value.trim()) {
                        isValid = false;
                        field?.classList.add('is-invalid');
                    } else {
                        field?.classList.remove('is-invalid');
                    }
                });
                
                if (!isValid) {
                    e.preventDefault();
                    alert('Please fill in all required fields: Title, Asset, and Threat Scenario');
                    return false;
                }
                
                // For qualitative assessments, check the specific fields
                const qualFields = ['Assessment.QualitativeLikelihood', 'Assessment.QualitativeImpact', 'Assessment.QualitativeExposure'];
                qualFields.forEach(fieldName => {
                    const field = document.querySelector(`[name="${fieldName}"]`);
                    if (!field || !field.value) {
                        isValid = false;
                        field?.classList.add('is-invalid');
                    } else {
                        field?.classList.remove('is-invalid');
                    }
                });
                
                if (!isValid) {
                    e.preventDefault();
                    alert('Please select Likelihood, Impact, and Exposure levels for the qualitative assessment');
                    return false;
                }
                
                // Allow form submission if valid
                return true;
            });
        });
        
        // FAIR insurance functions removed
    </script>
}