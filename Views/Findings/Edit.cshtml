@model CyberRiskApp.Models.Finding
@{
    ViewData["Title"] = "Edit Finding";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-edit me-2"></i>Edit Finding - @Model.FindingNumber
                    </h3>
                </div>
                <div class="card-body">
                    <form asp-action="Edit" method="post" id="findingForm">
                        <input asp-for="Id" type="hidden" />
                        <input asp-for="FindingNumber" type="hidden" />
                        <input asp-for="OpenDate" type="hidden" />
                        <input asp-for="CreatedAt" type="hidden" />
                        <input asp-for="UpdatedAt" type="hidden" />

                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        <div class="row g-3">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Finding Number: <strong>@Model.FindingNumber</strong> |
                                    Created: <strong>@Model.OpenDate.ToString("MMM dd, yyyy")</strong>
                                </div>
                            </div>

                            <div class="col-12">
                                <label asp-for="Title" class="form-label fw-bold">
                                    Title <span class="text-danger">*</span>
                                </label>
                                <input asp-for="Title" class="form-control form-control-lg"
                                       placeholder="Brief, descriptive title of the security finding" />
                                <span asp-validation-for="Title" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <label asp-for="Details" class="form-label fw-bold">
                                    Details <span class="text-danger">*</span>
                                </label>
                                <textarea asp-for="Details" class="form-control" rows="4"
                                          placeholder="Detailed description of the finding, including technical details and evidence"></textarea>
                                <span asp-validation-for="Details" class="text-danger"></span>
                            </div>

                            <!-- Status Section -->
                            <div class="col-md-6">
                                <label asp-for="Status" class="form-label fw-bold">Status</label>
                                <select asp-for="Status" class="form-select">
                                    <option value="1">Open</option>
                                    <option value="2">Closed</option>
                                    <option value="3">Risk Accepted</option>
                                </select>
                            </div>

                            <!-- Risk Assessment Section -->
                            <div class="col-12">
                                <hr class="my-4">
                                <h5 class="text-primary">
                                    <i class="fas fa-chart-line me-2"></i>Risk Assessment
                                </h5>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Impact" class="form-label fw-bold">Impact</label>
                                <select asp-for="Impact" class="form-select risk-factor" id="impact">
                                    <option value="1">Low</option>
                                    <option value="2">Medium</option>
                                    <option value="3">High</option>
                                    <option value="4">Critical</option>
                                </select>
                                <small class="text-muted">Potential damage if exploited</small>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Likelihood" class="form-label fw-bold">Likelihood</label>
                                <select asp-for="Likelihood" class="form-select risk-factor" id="likelihood">
                                    <option value="1">Unlikely</option>
                                    <option value="2">Possible</option>
                                    <option value="3">Likely</option>
                                    <option value="4">Almost Certain</option>
                                </select>
                                <small class="text-muted">Probability of exploitation</small>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Exposure" class="form-label fw-bold">Exposure</label>
                                <select asp-for="Exposure" class="form-select risk-factor" id="exposure">
                                    <option value="1">Slightly Exposed (0.2)</option>
                                    <option value="2">Exposed (0.4)</option>
                                    <option value="3">Moderately Exposed (0.8)</option>
                                    <option value="4">Highly Exposed (1.0)</option>
                                </select>
                                <small class="text-muted">Level of system exposure with decimal weight</small>
                            </div>

                            <!-- Auto-calculated Risk Rating -->
                            <div class="col-12">
                                <div class="alert alert-light border">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold mb-0">Overall Risk Rating (Auto-calculated)</label>
                                            <input asp-for="RiskRating" type="hidden" id="riskRatingValue" />
                                        </div>
                                        <div class="col-md-6 text-end">
                                            <span id="riskRatingDisplay" class="badge fs-5 bg-secondary">Low</span>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted" id="riskDescription">
                                            Based on Impact, Likelihood, and Exposure levels
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Ownership Section -->
                            <div class="col-12">
                                <hr class="my-4">
                                <h5 class="text-primary">
                                    <i class="fas fa-users me-2"></i>Ownership & Assignment
                                </h5>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Owner" class="form-label fw-bold">
                                    Technical Owner <span class="text-danger">*</span>
                                </label>
                                @Html.OwnerComboboxFor(m => m.Owner, canAddNew: User.IsInRole("Admin") || User.IsInRole("GRCAnalyst") || User.IsInRole("GRCManager"), required: true)
                            </div>

                            <div class="col-md-6">
                                <label asp-for="BusinessOwner" class="form-label fw-bold">Business Owner</label>
                                @Html.BusinessOwnerComboboxFor(m => m.BusinessOwner, canAddNew: User.IsInRole("Admin") || User.IsInRole("GRCAnalyst") || User.IsInRole("GRCManager"))
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Domain" class="form-label fw-bold">Domain</label>
                                @Html.AssetComboboxFor(m => m.Domain, canAddNew: User.IsInRole("Admin") || User.IsInRole("GRCAnalyst") || User.IsInRole("GRCManager"))
                            </div>

                            <div class="col-md-6">
                                <label asp-for="BusinessUnit" class="form-label fw-bold">Business Unit</label>
                                @Html.BusinessUnitComboboxFor(m => m.BusinessUnit, canAddNew: User.IsInRole("Admin") || User.IsInRole("GRCAnalyst") || User.IsInRole("GRCManager"))
                            </div>

                            <!-- Asset & Timeline Section -->
                            <div class="col-12">
                                <hr class="my-4">
                                <h5 class="text-primary">
                                    <i class="fas fa-server me-2"></i>Asset & Timeline
                                </h5>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Asset" class="form-label fw-bold">Affected Asset</label>
                                @Html.AssetComboboxFor(m => m.Asset, canAddNew: User.IsInRole("Admin") || User.IsInRole("GRCAnalyst") || User.IsInRole("GRCManager"))
                            </div>

                            <div class="col-md-6">
                                <label asp-for="TechnicalControl" class="form-label fw-bold">Technical Control</label>
                                @Html.TechnicalControlComboboxFor(m => m.TechnicalControl, canAddNew: User.IsInRole("Admin") || User.IsInRole("GRCAnalyst") || User.IsInRole("GRCManager"))
                            </div>

                            <div class="col-md-6">
                                <label asp-for="SlaDate" class="form-label fw-bold">Target Resolution Date</label>
                                <input asp-for="SlaDate" type="date" class="form-control" />
                                <small class="text-muted">When this finding should be resolved</small>
                            </div>

                            <div class="col-12 pt-4">
                                <div class="d-flex gap-3">
                                    <button type="submit" class="btn btn-warning btn-lg" id="submitBtn">
                                        <i class="fas fa-save me-2"></i>Update Finding
                                    </button>
                                    <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-info btn-lg">
                                        <i class="fas fa-eye me-2"></i>View Details
                                    </a>
                                    <a asp-action="Index" class="btn btn-secondary btn-lg">
                                        <i class="fas fa-list me-2"></i>Back to List
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        function calculateRiskRating() {
            const impact = parseInt(document.getElementById('impact').value) || 1;
            const likelihood = parseInt(document.getElementById('likelihood').value) || 1;
            const exposureEnum = parseInt(document.getElementById('exposure').value) || 1;

            // Map exposure enum values to decimal values
            const exposureValues = {
                1: 0.2,  // Slightly Exposed
                2: 0.4,  // Exposed
                3: 0.8,  // Moderately Exposed
                4: 1.0   // Highly Exposed
            };

            const exposure = exposureValues[exposureEnum];

            // Risk calculation logic using decimal exposure
            let riskScore = 0;
            let riskLevel = 'Low';
            let riskClass = 'success';
            let description = '';

            // Calculate weighted score (Impact and Likelihood are 1-4, Exposure is 0.2-1.0)
            const exposureForAverage = exposure * 4;
            const weightedScore = (impact + likelihood + exposureForAverage) / 3;
            const finalRiskScore = weightedScore * exposure;

            // Determine risk rating with decimal exposure consideration
            if (impact === 4 && likelihood === 4 && exposureEnum === 4) {
                riskScore = 4;
                riskLevel = 'Critical';
                riskClass = 'danger';
                description = 'Maximum risk with full exposure - immediate attention required';
            } else if (finalRiskScore >= 3.0) {
                riskScore = 3;
                riskLevel = 'High';
                riskClass = 'warning';
                description = 'High risk - priority remediation needed';
            } else if (finalRiskScore >= 2.0) {
                riskScore = 2;
                riskLevel = 'Medium';
                riskClass = 'info';
                description = 'Medium risk - scheduled remediation recommended';
            } else {
                riskScore = 1;
                riskLevel = 'Low';
                riskClass = 'success';
                description = 'Low risk - monitor and address when convenient';
            }

            // Update the display
            const displayElement = document.getElementById('riskRatingDisplay');
            const hiddenElement = document.getElementById('riskRatingValue');
            const descriptionElement = document.getElementById('riskDescription');

            displayElement.textContent = riskLevel;
            displayElement.className = `badge fs-5 bg-${riskClass}`;
            hiddenElement.value = riskScore;
            descriptionElement.innerHTML = `${description}<br><small class="text-muted">Exposure Weight: ${exposure} | Calculation: (${impact} + ${likelihood} + ${exposureForAverage.toFixed(1)}) ÷ 3 × ${exposure} = ${finalRiskScore.toFixed(2)}</small>`;
        }

        // Calculate risk rating when page loads
        document.addEventListener('DOMContentLoaded', function() {
            calculateRiskRating();

            // Add event listeners to all risk factors
            document.querySelectorAll('.risk-factor').forEach(function(element) {
                element.addEventListener('change', calculateRiskRating);
            });
        });

        // Form validation before submit
        document.getElementById('findingForm').addEventListener('submit', function(e) {
            const title = document.getElementById('Title').value.trim();
            const details = document.getElementById('Details').value.trim();
            const owner = document.getElementById('Owner').value.trim();

            if (!title || !details || !owner) {
                e.preventDefault();
                alert('Please fill in all required fields (Title, Details, and Owner).');
                return false;
            }

            // Ensure risk rating is calculated
            calculateRiskRating();

            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
            submitBtn.disabled = true;
        });
    </script>
}